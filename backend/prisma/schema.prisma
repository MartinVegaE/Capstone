generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * MODELOS EN ESPAÑOL (PPP)
 * =========================
 */

model Producto {
  id            Int      @id @default(autoincrement())
  sku           String   @unique
  nombre        String
  marca         String?
  categoria     String?
  stock         Int      @default(0)
  ubicacion     String?
  codigoBarras  String?  @unique
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  ppp           Decimal  @default(0) // Decimal sin @db.* para SQLite

  // Lados opuestos de relaciones
  ingresoItems     IngresoItem[]
  stockMovimientos StockMovimiento[]
  movProyectoItems MovimientoProyectoItem[]
}

model Ingreso {
  id          Int      @id @default(autoincrement())
  fecha       DateTime @default(now())
  proveedor   String?
  documento   String?
  observacion String?

  items IngresoItem[]
}

model IngresoItem {
  id            Int       @id @default(autoincrement())
  ingresoId     Int
  productoId    Int
  cantidad      Int
  costoUnitario Decimal // sin @db.* para SQLite
  lote          String?
  venceAt       DateTime?

  ingreso  Ingreso  @relation(fields: [ingresoId], references: [id])
  producto Producto @relation(fields: [productoId], references: [id])
}

model StockMovimiento {
  id            Int            @id @default(autoincrement())
  productoId    Int
  tipo          MovimientoTipo
  cantidad      Int
  costoUnitario Decimal? // sin @db.*
  pppAntes      Decimal
  pppDespues    Decimal
  refTipo       RefTipo
  refId         Int?
  createdAt     DateTime       @default(now())

  producto Producto @relation(fields: [productoId], references: [id])
}

enum MovimientoTipo {
  IN
  OUT
  ADJUST
}

enum RefTipo {
  INGRESO
  VENTA
  AJUSTE
  PROYECTO_SALIDA
  PROYECTO_RETORNO
}

/**
 * ===================================
 * MODELOS EN INGLÉS
 * ===================================
 */

enum MovementType {
  IN
  OUT
  ADJUST
  SET
}

enum ProductKind {
  CONSUMABLE
  TOOL
  FIXED_ASSET
}

model Product {
  id             Int             @id @default(autoincrement())
  code           String          @unique
  name           String
  description    String?
  unit           String
  kind           ProductKind     @default(CONSUMABLE)
  isActive       Boolean         @default(true)
  minStock       Float?
  maxStock       Float?
  categoryId     Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stockMovements StockMovement[]
}

model StockMovement {
  id        Int          @id @default(autoincrement())
  productId Int
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  type      MovementType
  delta     Int
  before    Int
  after     Int
  reason    String?
  source    String?
  actor     String?
  createdAt DateTime     @default(now())

  @@index([productId, createdAt])
}

enum ProyectoMovTipo {
  SALIDA
  RETORNO
}

model MovimientoProyecto {
  id          Int                      @id @default(autoincrement())
  proyecto    String
  tipo        ProyectoMovTipo
  fecha       DateTime                 @default(now())
  documento   String?
  observacion String?
  items       MovimientoProyectoItem[]
}

model MovimientoProyectoItem {
  id            Int      @id @default(autoincrement())
  movimientoId  Int
  productoId    Int
  cantidad      Int
  costoUnitario Decimal?

  movimiento MovimientoProyecto @relation(fields: [movimientoId], references: [id])
  producto   Producto           @relation(fields: [productoId], references: [id])
}

// --- Enums de roles del sistema y tipo de trabajador ---

enum UserRole {
  ADMIN // administración de usuarios / configuración
  WAREHOUSE // bodeguero
  DRIVER // chofer / despachador
  SUPERVISOR // opcional: jefes / supervisores
}

enum WorkerType {
  MAESTRO
  BODEGUERO
  CHOFER
  ADMINISTRATIVO
  OTRO
}

// --- Trabajadores (personas reales) ---

model Worker {
  id        Int        @id @default(autoincrement())
  fullName  String
  rut       String     @unique
  email     String? // correo de contacto (no necesariamente de login)
  phone     String?
  type      WorkerType @default(OTRO)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relación 1-1 opcional con User
  user User?
}

// --- Usuarios del sistema (login) ---

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique // correo para login (bodeguero1@..., etc.)
  passwordHash String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // vínculo opcional a Worker
  workerId Int?    @unique
  worker   Worker? @relation(fields: [workerId], references: [id])
}

model Categoria {
  id     Int    @id @default(autoincrement())
  nombre String @unique
}

model Marca {
  id     Int    @id @default(autoincrement())
  nombre String @unique
}

model Bodega {
  id     Int     @id @default(autoincrement())
  nombre String  @unique
  codigo String? @unique
  // más campos: direccion, etc. (si quieres luego)
}

model Proyecto {
  id     Int    @id @default(autoincrement())
  nombre String @unique
  // etc.
}
