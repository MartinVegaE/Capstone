generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * INVENTARIO (PPP)
 * =========================
 */

enum MovimientoTipo {
  IN
  OUT
  ADJUST
}

enum RefTipo {
  INGRESO
  MOVIMIENTO_PROYECTO_SALIDA
  MOVIMIENTO_PROYECTO_RETORNO
  DEVOLUCION_PROVEEDOR
  AJUSTE
}

enum TipoDocumento {
  FACTURA
  GUIA_DESPACHO
  NOTA_CREDITO
  OTRO
}

enum ProyectoMovTipo {
  SALIDA
  RETORNO
}

/**
 * Catálogo de productos
 */

model Categoria {
  id            Int            @id @default(autoincrement())
  codigo        String         @unique // EXT, DET, ACF, FUN
  nombre        String         @unique
  subcategorias Subcategoria[]
  productos     Producto[]
}

model Subcategoria {
  id          Int        @id @default(autoincrement())
  nombre      String
  categoriaId Int
  categoria   Categoria  @relation(fields: [categoriaId], references: [id])
  productos   Producto[]

  @@unique([categoriaId, nombre])
}

model Proveedor {
  id        Int     @id @default(autoincrement())
  nombre    String
  rut       String? @unique
  email     String?
  telefono  String?
  direccion String?
  activo    Boolean @default(true)

  productos             Producto[]
  ingresos              Ingreso[]
  devolucionesProveedor DevolucionProveedor[]
}

model Bodega {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique
  codigo      String? @unique
  esPrincipal Boolean @default(false)
  ubicacion   String?

  ingresos              Ingreso[]
  movimientosProyecto   MovimientoProyecto[]
  devolucionesProveedor DevolucionProveedor[]
}

model Proyecto {
  id            Int      @id @default(autoincrement())
  nombre        String   @unique
  codigo        String?  @unique
  descripcion   String?
  activo        Boolean  @default(true)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  movimientos MovimientoProyecto[]
}

model Producto {
  id             Int           @id @default(autoincrement())
  sku            String        @unique
  nombre         String
  descripcion    String?
  categoriaId    Int
  categoria      Categoria     @relation(fields: [categoriaId], references: [id])
  subcategoriaId Int?
  subcategoria   Subcategoria? @relation(fields: [subcategoriaId], references: [id])
  proveedorId    Int
  proveedor      Proveedor     @relation(fields: [proveedorId], references: [id])
  stock          Int           @default(0)
  stockMinimo    Int           @default(0)
  ubicacion      String?
  codigoBarras   String?       @unique
  imagenUrl      String?
  creadoEn       DateTime      @default(now())
  actualizadoEn  DateTime      @updatedAt
  ppp            Decimal       @default(0) @db.Decimal(12, 2)

  ingresoItems             IngresoItem[]
  stockMovimientos         StockMovimiento[]
  movProyectoItems         MovimientoProyectoItem[]
  devolucionProveedorItems DevolucionProveedorItem[]
}

/**
 * Ingresos de mercadería (compras y carga inicial)
 */

model Ingreso {
  id              Int           @id @default(autoincrement())
  fecha           DateTime      @default(now())
  proveedorId     Int
  proveedor       Proveedor     @relation(fields: [proveedorId], references: [id])
  bodegaId        Int
  bodega          Bodega        @relation(fields: [bodegaId], references: [id])
  tipoDocumento   TipoDocumento
  numeroDocumento String
  observacion     String?

  items IngresoItem[]
}

model IngresoItem {
  id            Int       @id @default(autoincrement())
  ingresoId     Int
  productoId    Int
  cantidad      Int
  costoUnitario Decimal   @db.Decimal(12, 2)
  lote          String?
  venceAt       DateTime?

  ingreso  Ingreso  @relation(fields: [ingresoId], references: [id])
  producto Producto @relation(fields: [productoId], references: [id])
}

/**
 * Movimientos de stock (log PPP)
 */

model StockMovimiento {
  id            Int            @id @default(autoincrement())
  productoId    Int
  producto      Producto       @relation(fields: [productoId], references: [id])
  tipo          MovimientoTipo
  cantidad      Int
  costoUnitario Decimal?       @db.Decimal(12, 2)
  pppAntes      Decimal        @db.Decimal(12, 2)
  pppDespues    Decimal        @db.Decimal(12, 2)
  refTipo       RefTipo
  refId         Int?
  createdAt     DateTime       @default(now())

  @@index([productoId, createdAt])
}

/**
 * Movimientos hacia/desde proyectos (centros de costo)
 */

model MovimientoProyecto {
  id              Int             @id @default(autoincrement())
  proyectoId      Int
  proyecto        Proyecto        @relation(fields: [proyectoId], references: [id])
  tipo            ProyectoMovTipo
  fecha           DateTime        @default(now())
  bodegaId        Int
  bodega          Bodega          @relation(fields: [bodegaId], references: [id])
  tipoDocumento   TipoDocumento?
  numeroDocumento String?
  observacion     String?

  items MovimientoProyectoItem[]
}

model MovimientoProyectoItem {
  id            Int      @id @default(autoincrement())
  movimientoId  Int
  productoId    Int
  cantidad      Int
  costoUnitario Decimal? @db.Decimal(12, 2)

  movimiento MovimientoProyecto @relation(fields: [movimientoId], references: [id])
  producto   Producto           @relation(fields: [productoId], references: [id])
}

/**
 * Devoluciones a proveedores (nota de crédito)
 */

model DevolucionProveedor {
  id              Int           @id @default(autoincrement())
  fecha           DateTime      @default(now())
  proveedorId     Int
  proveedor       Proveedor     @relation(fields: [proveedorId], references: [id])
  bodegaId        Int
  bodega          Bodega        @relation(fields: [bodegaId], references: [id])
  tipoDocumento   TipoDocumento @default(NOTA_CREDITO)
  numeroDocumento String
  observacion     String?

  items DevolucionProveedorItem[]
}

model DevolucionProveedorItem {
  id            Int      @id @default(autoincrement())
  devolucionId  Int
  productoId    Int
  cantidad      Int
  costoUnitario Decimal? @db.Decimal(12, 2)

  devolucion DevolucionProveedor @relation(fields: [devolucionId], references: [id])
  producto   Producto            @relation(fields: [productoId], references: [id])
}

/**
 * Usuarios / autenticación
 */

enum UserRole {
  ADMIN
  WAREHOUSE
  DRIVER
  SUPERVISOR
}

enum WorkerType {
  MAESTRO
  BODEGUERO
  CHOFER
  ADMINISTRATIVO
  OTRO
}

model Worker {
  id        Int        @id @default(autoincrement())
  fullName  String
  rut       String     @unique
  email     String?
  phone     String?
  type      WorkerType @default(OTRO)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User?
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workerId Int?    @unique
  worker   Worker? @relation(fields: [workerId], references: [id])
}
